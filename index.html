<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sachs Gaming Club</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex items-center justify-center hidden">
        <div class="flex items-center space-x-2 animate-pulse">
            <div class="w-4 h-4 bg-purple-500 rounded-full"></div>
            <div class="w-4 h-4 bg-pink-500 rounded-full"></div>
            <div class="w-4 h-4 bg-blue-500 rounded-full"></div>
        </div>
    </div>

    <!-- Main Container -->
    <div id="mainContainer" class="bg-gray-800 rounded-xl shadow-lg w-full max-w-2xl overflow-hidden hidden">

        <!-- Set Display Name Section -->
        <div id="authSection" class="p-6">
            <div class="text-center mb-6">
                <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-600">Sachs Gaming Club</h1>
                <p class="text-gray-400 mt-2">Welcome! Please enter a display name to join the chat.</p>
            </div>
            
            <form id="authForm" class="space-y-4">
                <input type="text" id="username" placeholder="Display Name" required 
                       class="w-full p-3 rounded-lg bg-gray-700 text-gray-100 border border-gray-600 focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50 transition duration-300">
                
                <button type="submit" id="authButton" 
                        class="w-full p-3 rounded-lg text-white font-bold bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 transition duration-300 transform hover:scale-105">
                    Enter Chat
                </button>
            </form>
            
            <p id="authError" class="text-center text-red-500 mt-4 hidden"></p>
        </div>

        <!-- Chat Section -->
        <div id="chatSection" class="flex flex-col h-[80vh] hidden">
            <!-- Header -->
            <div class="flex-shrink-0 p-4 border-b border-gray-700 flex items-center justify-between bg-gray-800">
                <h2 id="chatTitle" class="text-xl font-bold text-purple-400"></h2>
                <button id="logoutButton" class="text-gray-400 hover:text-red-500 transition duration-300 text-sm">Change Name</button>
            </div>

            <!-- Messages List -->
            <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto space-y-4">
                <!-- Messages will be injected here -->
            </div>

            <!-- Message Input & Send Button -->
            <div class="flex-shrink-0 p-4 border-t border-gray-700 bg-gray-800">
                <form id="messageForm" class="flex items-center space-x-2">
                    <input type="text" id="messageInput" placeholder="Type a message..." required
                           class="flex-1 p-3 rounded-full bg-gray-700 text-gray-100 border border-gray-600 focus:border-purple-500 focus:ring focus:ring-purple-500 focus:ring-opacity-50 transition duration-300">
                    <button type="submit"
                            class="p-3 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 text-white transform hover:scale-110 transition duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                        </svg>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI Elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const mainContainer = document.getElementById('mainContainer');
        const authSection = document.getElementById('authSection');
        const chatSection = document.getElementById('chatSection');
        const authForm = document.getElementById('authForm');
        const authButton = document.getElementById('authButton');
        const authError = document.getElementById('authError');
        const chatTitle = document.getElementById('chatTitle');
        const messagesContainer = document.getElementById('messagesContainer');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const logoutButton = document.getElementById('logoutButton');
        const usernameInput = document.getElementById('username');

        // Firebase Initialization
        let auth, db;
        let loggedInUser = null;
        let isAuthReady = false;
        
        document.addEventListener('DOMContentLoaded', async () => {
            showLoading(true);
            try {
                if (!firebaseConfig || !firebaseConfig.projectId) {
                    throw new Error("Missing or invalid Firebase configuration.");
                }

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                
                onAuthStateChanged(auth, async (user) => {
                    try {
                        if (user) {
                            isAuthReady = true;
                            // Check if username is already set, if not, show auth screen
                            if (loggedInUser) {
                                chatTitle.textContent = `Welcome, ${loggedInUser.username}!`;
                                showChat();
                                fetchMessages();
                            } else {
                                showAuth();
                            }
                        } else {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        }
                    } catch (error) {
                        console.error("Sign-in failed:", error);
                        authError.textContent = "Sign-in failed. Please refresh the page.";
                        authError.classList.remove('hidden');
                        showAuth();
                    } finally {
                        showLoading(false);
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authError.textContent = "App failed to start. Please try again or check your embedding settings.";
                authError.classList.remove('hidden');
                showLoading(false);
                showAuth();
            }
        });

        function showLoading(show) {
            loadingOverlay.classList.toggle('hidden', !show);
            mainContainer.classList.toggle('hidden', show);
        }
        
        function showAuth() {
            authSection.classList.remove('hidden');
            chatSection.classList.add('hidden');
        }

        function showChat() {
            authSection.classList.add('hidden');
            chatSection.classList.remove('hidden');
        }
        
        // Auth form submission handler (setting display name)
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = usernameInput.value.trim();
            if (!username) {
                authError.textContent = "Please enter a display name.";
                authError.classList.remove('hidden');
                return;
            }

            loggedInUser = { username: username, userId: auth.currentUser.uid };
            chatTitle.textContent = `Welcome, ${loggedInUser.username}!`;
            showChat();
            fetchMessages();
        });

        // "Change Name" button
        logoutButton.addEventListener('click', async () => {
            try {
                loggedInUser = null;
                await signOut(auth);
                showAuth();
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });

        // Message sending
        messageForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!loggedInUser || !isAuthReady) {
                console.error("User not logged in or auth not ready. Cannot send message.");
                authError.textContent = "Please enter a display name to send a message.";
                authError.classList.remove('hidden');
                return;
            }

            const messageText = messageInput.value.trim();
            if (!messageText) return;

            const temporaryMessage = {
                id: `temp-${Date.now()}`,
                text: messageText,
                sender: loggedInUser.username,
                userId: loggedInUser.userId,
                timestamp: new Date()
            };

            displayMessage(temporaryMessage);
            messageInput.value = '';

            try {
                await addDoc(collection(db, `/artifacts/${appId}/public/data/messages`), {
                    text: temporaryMessage.text,
                    sender: temporaryMessage.sender,
                    userId: temporaryMessage.userId,
                    timestamp: serverTimestamp()
                });
                
            } catch (error) {
                console.error("Error sending message:", error);
                // We'll let onSnapshot handle the UI update once a doc is successfully added.
            }
        });

        function displayMessage(message) {
            const messageElement = document.createElement('div');
            const isMyMessage = loggedInUser && message.userId === loggedInUser.userId;
            
            messageElement.className = `p-3 rounded-lg max-w-xs transition duration-300 transform ${isMyMessage ? 'bg-purple-600 text-white self-end ml-auto' : 'bg-gray-700 text-gray-200 self-start mr-auto'}`;
            messageElement.setAttribute('data-id', message.id);
            
            let content = '';
            content += `<p class="font-bold text-sm mb-1">${message.sender}</p>`;
            if (message.text) {
                content += `<p>${message.text}</p>`;
            }
            const timestamp = message.timestamp instanceof Date ? message.timestamp : (message.timestamp?.toDate() || new Date());
            content += `<p class="text-xs text-right mt-1 opacity-70">${timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>`;
            
            messageElement.innerHTML = content;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Fetching messages and setting up real-time listener
        function fetchMessages() {
            const messagesCollection = collection(db, `/artifacts/${appId}/public/data/messages`);
            
            onSnapshot(messagesCollection, (snapshot) => {
                const messages = [];
                snapshot.forEach((doc) => {
                    messages.push({ id: doc.id, ...doc.data() });
                });
                
                messages.sort((a, b) => (a.timestamp?.toDate() || 0) - (b.timestamp?.toDate() || 0));

                messagesContainer.innerHTML = '';
                messages.forEach((message) => displayMessage(message));
            });
        }
    </script>
</body>
</html>
